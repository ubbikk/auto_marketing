<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AFTA Marketing for LinkedIn</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --surface: #060918;
  --surface-muted: #0d1128;
  --surface-highlight: #141938;
  --surface-border: #1a1f3c;
  --surface-foreground: #e8eaf6;
  --primary-50: #e6fbff;
  --primary-100: #b3f3ff;
  --primary-200: #80ebff;
  --primary-300: #4de3ff;
  --primary-400: #1adbff;
  --primary-500: #00d4ff;
  --primary-600: #00a8cc;
  --primary-700: #007c99;
  --accent: #f59e0b;
  --accent-light: #fbbf24;
  --electric-purple: #8b5cf6;
  --electric-pink: #ec4899;
  --font-display: 'Syne', sans-serif;
  --font-body: 'Plus Jakarta Sans', sans-serif;
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  background: var(--surface);
  color: var(--surface-foreground);
  font-family: var(--font-body);
  font-feature-settings: "ss01", "ss02", "cv01";
  -webkit-font-smoothing: antialiased;
  min-height: 100vh;
  overflow-x: hidden;
}

::selection { background: rgba(0, 212, 255, 0.4); color: #fff; }

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--surface); }
::-webkit-scrollbar-thumb { background: var(--surface-border); border-radius: 999px; }
::-webkit-scrollbar-thumb:hover { background: var(--primary-700); }

/* ===== NOISE + GRID ===== */
.noise-overlay {
  position: fixed; inset: 0; pointer-events: none; opacity: 0.015; z-index: 100;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}

.grid-bg {
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background-image:
    linear-gradient(rgba(26, 31, 60, 0.35) 1px, transparent 1px),
    linear-gradient(90deg, rgba(26, 31, 60, 0.35) 1px, transparent 1px);
  background-size: 60px 60px;
}

/* ===== GLOW ORBS ===== */
.glow-orb {
  position: absolute; border-radius: 50%; pointer-events: none; z-index: 0;
  filter: blur(80px);
}
.glow-orb--cyan { background: radial-gradient(circle, rgba(0,212,255,0.4) 0%, transparent 70%); }
.glow-orb--purple { background: radial-gradient(circle, rgba(139,92,246,0.3) 0%, transparent 70%); }
.glow-orb--accent { background: radial-gradient(circle, rgba(245,158,11,0.25) 0%, transparent 70%); }

/* ===== LAYOUT ===== */
.shell { max-width: 1200px; margin: 0 auto; padding: 0 24px; }
@media (min-width: 640px) { .shell { padding: 0 32px; } }
@media (min-width: 1024px) { .shell { padding: 0 48px; } }

section { position: relative; z-index: 1; }

/* ===== TYPOGRAPHY ===== */
.heading-display {
  font-family: var(--font-display);
  font-weight: 700;
  letter-spacing: -0.02em;
  line-height: 1.15;
  text-wrap: balance;
}

.heading-gradient {
  background: linear-gradient(135deg, #ffffff 0%, var(--primary-200) 40%, var(--primary-400) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}

.text-glow { text-shadow: 0 0 40px rgba(0, 212, 255, 0.5); }

/* ===== BADGE ===== */
.badge {
  display: inline-flex; align-items: center; gap: 8px;
  border: 1px solid rgba(0,212,255,0.3); background: rgba(0,212,255,0.08);
  border-radius: 999px; padding: 8px 20px;
  font-size: 12px; font-weight: 600; color: var(--primary-300);
  letter-spacing: 0.1em; text-transform: uppercase;
}
.badge__dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--primary-500);
  box-shadow: 0 0 12px rgba(0,212,255,0.6);
  animation: pulse-glow 2s ease-in-out infinite;
}

/* ===== DIVIDER ===== */
.section-divider {
  height: 1px; width: 100%;
  background: linear-gradient(90deg, transparent 0%, rgba(0,212,255,0.3) 50%, transparent 100%);
}

/* ===== CARDS ===== */
.card {
  position: relative; border-radius: 16px;
  border: 1px solid rgba(26,31,60,0.5);
  background: linear-gradient(145deg, rgba(13,17,40,0.8) 0%, rgba(6,9,24,0.9) 100%);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  transition: all 0.4s ease;
}
.card:hover {
  border-color: rgba(0,212,255,0.2);
  box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 40px rgba(0,212,255,0.05);
}
.card--glow {
  box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 60px rgba(0,212,255,0.1);
}

/* ===== BUTTONS ===== */
.btn-primary {
  display: inline-flex; align-items: center; justify-content: center; gap: 10px;
  border-radius: 999px; padding: 14px 32px;
  font-family: var(--font-body); font-size: 15px; font-weight: 600;
  color: var(--surface); border: none; cursor: pointer;
  background: linear-gradient(135deg, #00d4ff 0%, #00a8cc 100%);
  box-shadow: 0 4px 20px rgba(0,212,255,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
  transition: all 0.3s ease; text-decoration: none;
}
.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(0,212,255,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
}
.btn-primary:active { transform: translateY(0); }
.btn-primary:disabled {
  opacity: 0.5; cursor: not-allowed; transform: none !important;
}
.btn-primary--lg { padding: 18px 48px; font-size: 17px; font-weight: 700; }
.btn-primary--full { width: 100%; }

.btn-ghost {
  display: inline-flex; align-items: center; justify-content: center; gap: 8px;
  border-radius: 999px; padding: 12px 24px;
  font-family: var(--font-body); font-size: 14px; font-weight: 600;
  color: var(--surface-foreground); cursor: pointer;
  border: 1px solid rgba(26,31,60,0.6);
  background: rgba(13,17,40,0.3); backdrop-filter: blur(8px);
  transition: all 0.3s ease; text-decoration: none;
}
.btn-ghost:hover {
  border-color: rgba(0,212,255,0.4); color: var(--primary-300);
  background: rgba(0,212,255,0.08);
  box-shadow: 0 0 20px rgba(0,212,255,0.1);
}

/* ===== FORM ELEMENTS ===== */
.form-label {
  display: block; font-size: 13px; font-weight: 600;
  color: var(--surface-foreground); margin-bottom: 8px;
  letter-spacing: 0.02em;
}
.form-hint {
  font-size: 12px; color: rgba(232,234,246,0.4); margin-top: 4px;
}

.form-input, .form-textarea {
  width: 100%; padding: 14px 18px;
  border: 1px solid var(--surface-border); border-radius: 12px;
  background: rgba(13,17,40,0.5);
  color: var(--surface-foreground); font-family: var(--font-body); font-size: 15px;
  transition: all 0.3s ease; outline: none;
}
.form-input::placeholder, .form-textarea::placeholder {
  color: rgba(232,234,246,0.3);
}
.form-input:focus, .form-textarea:focus {
  border-color: var(--primary-500);
  box-shadow: 0 0 0 3px rgba(0,212,255,0.15);
}
.form-textarea { resize: vertical; min-height: 80px; line-height: 1.5; }

/* ===== URL INPUT WITH LOGO ===== */
.url-input-wrap {
  position: relative; display: flex; align-items: center; gap: 12px;
}
.url-input-wrap .form-input { flex: 1; }
.logo-preview {
  width: 44px; height: 44px; border-radius: 10px;
  border: 1px solid var(--surface-border);
  background: var(--surface-muted);
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; flex-shrink: 0;
  transition: all 0.3s ease;
}
.logo-preview img {
  width: 100%; height: 100%; object-fit: contain; padding: 4px;
}
.logo-preview--loading {
  animation: pulse-glow 1.5s ease-in-out infinite;
}

/* ===== SOURCE TOGGLE ===== */
.source-toggle {
  display: flex; border-radius: 10px; overflow: hidden;
  border: 1px solid var(--surface-border);
  background: rgba(13,17,40,0.5);
}
.source-toggle__btn {
  flex: 1; padding: 10px 16px; border: none; cursor: pointer;
  font-family: var(--font-body); font-size: 13px; font-weight: 600;
  color: rgba(232,234,246,0.5); background: transparent;
  transition: all 0.3s ease;
}
.source-toggle__btn--active {
  color: var(--primary-300);
  background: rgba(0,212,255,0.1);
  box-shadow: inset 0 -2px 0 var(--primary-500);
}

/* ===== PERSONA CARDS ===== */
.persona-grid {
  display: grid; grid-template-columns: 1fr; gap: 12px;
}
@media (min-width: 640px) { .persona-grid { grid-template-columns: repeat(2, 1fr); } }
@media (min-width: 900px) { .persona-grid { grid-template-columns: repeat(3, 1fr); } }

.persona-card {
  padding: 20px; border-radius: 14px; cursor: pointer;
  border: 1px solid rgba(26,31,60,0.5);
  background: linear-gradient(145deg, rgba(13,17,40,0.6) 0%, rgba(6,9,24,0.8) 100%);
  transition: all 0.3s ease;
}
.persona-card:hover {
  border-color: rgba(0,212,255,0.2);
  transform: translateY(-2px);
}
.persona-card--selected {
  border-color: rgba(0,212,255,0.5) !important;
  box-shadow: 0 0 30px rgba(0,212,255,0.12), inset 0 1px 0 rgba(0,212,255,0.1);
  background: linear-gradient(145deg, rgba(0,212,255,0.06) 0%, rgba(13,17,40,0.8) 100%);
}
.persona-card__name {
  font-family: var(--font-display); font-weight: 700; font-size: 16px;
  color: #fff; margin-bottom: 6px;
}
.persona-card__desc {
  font-size: 13px; color: rgba(232,234,246,0.55); line-height: 1.45; margin-bottom: 10px;
}
.persona-card__opener {
  font-size: 12px; color: rgba(232,234,246,0.35); font-style: italic;
  line-height: 1.4; border-top: 1px solid rgba(26,31,60,0.5); padding-top: 10px;
}

/* ===== STAT CARDS (results) ===== */
.stat-card {
  position: relative; overflow: hidden; border-radius: 12px;
  border: 1px solid rgba(26,31,60,0.3); padding: 16px; text-align: center;
  background: linear-gradient(145deg, rgba(13,17,40,0.6) 0%, rgba(6,9,24,0.8) 100%);
}
.stat-card__value {
  font-family: var(--font-display); font-size: 28px; font-weight: 700;
  font-variant-numeric: tabular-nums lining-nums;
  background: linear-gradient(135deg, var(--primary-300) 0%, var(--primary-400) 50%, var(--accent) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.stat-card__label {
  font-size: 11px; color: rgba(232,234,246,0.5); margin-top: 4px;
  font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;
}
.stat-card__weight {
  font-size: 10px; color: rgba(232,234,246,0.25); margin-top: 2px;
}

/* ===== WINNER CARD ===== */
.winner-card {
  position: relative; padding: 32px; border-radius: 16px;
  border: 1px solid rgba(0,212,255,0.2);
  background: linear-gradient(145deg, rgba(0,212,255,0.04) 0%, rgba(6,9,24,0.95) 100%);
  backdrop-filter: blur(20px);
  box-shadow: 0 8px 40px rgba(0,0,0,0.3), 0 0 60px rgba(0,212,255,0.08);
}
.winner-card__header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px; gap: 12px; flex-wrap: wrap;
}
.winner-card__content {
  font-size: 15px; line-height: 1.7; color: rgba(232,234,246,0.85);
  white-space: pre-wrap; word-wrap: break-word;
}
.copy-btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 16px; border-radius: 8px; border: 1px solid var(--surface-border);
  background: var(--surface-muted); color: var(--surface-foreground);
  font-size: 12px; font-weight: 600; cursor: pointer;
  font-family: var(--font-body); transition: all 0.2s ease;
}
.copy-btn:hover {
  border-color: rgba(0,212,255,0.3); color: var(--primary-300);
}
.copy-btn--copied { border-color: #10b981; color: #10b981; }

/* ===== SCORE CIRCLE ===== */
.score-circle {
  width: 56px; height: 56px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-display); font-size: 18px; font-weight: 800;
  font-variant-numeric: tabular-nums lining-nums;
  background: linear-gradient(135deg, rgba(0,212,255,0.15) 0%, rgba(139,92,246,0.1) 100%);
  border: 2px solid rgba(0,212,255,0.3);
  color: var(--primary-300);
}

/* ===== COLLAPSIBLE ===== */
.collapsible__trigger {
  display: flex; align-items: center; gap: 8px; cursor: pointer;
  padding: 14px 0; font-size: 14px; font-weight: 600;
  color: rgba(232,234,246,0.6); transition: color 0.2s; border: none; background: none;
  font-family: var(--font-body); width: 100%; text-align: left;
}
.collapsible__trigger:hover { color: var(--primary-300); }
.collapsible__trigger svg { transition: transform 0.3s; }
.collapsible__trigger--open svg { transform: rotate(180deg); }
.collapsible__body {
  max-height: 0; overflow: hidden; transition: max-height 0.4s ease;
}
.collapsible__body--open { max-height: 5000px; }

/* ===== AUTO-FETCH CARD ===== */
.auto-fetch-card {
  padding: 20px; border-radius: 12px;
  border: 1px dashed rgba(0,212,255,0.2);
  background: rgba(0,212,255,0.03);
  display: flex; align-items: center; gap: 14px;
}
.auto-fetch-card__icon {
  width: 40px; height: 40px; border-radius: 10px;
  background: rgba(0,212,255,0.1); display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}

/* ===== PROMO VIDEO ===== */
.promo-video-wrap {
  position: relative; width: 100%; border-radius: 16px; overflow: hidden;
  border: 1px solid rgba(26,31,60,0.5);
  background: #060918;
  box-shadow: 0 24px 80px rgba(0,0,0,0.5), 0 0 60px rgba(0,212,255,0.06);
}
.promo-video-wrap video {
  display: block; width: 100%; height: auto; border-radius: 16px;
}
.promo-video-wrap video::-webkit-media-controls-panel {
  background: linear-gradient(transparent, rgba(6,9,24,0.8));
}

/* ===== LOADING ===== */
.loading-overlay {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 32px; padding: 80px 24px; text-align: center;
}
.loading-orb {
  width: 120px; height: 120px; border-radius: 50%; position: relative;
}
.loading-orb::before {
  content: ''; position: absolute; inset: 0; border-radius: 50%;
  background: radial-gradient(circle, rgba(0,212,255,0.4) 0%, transparent 70%);
  animation: loading-pulse 2s ease-in-out infinite;
}
.loading-orb::after {
  content: ''; position: absolute; inset: 8px; border-radius: 50%;
  border: 2px solid transparent; border-top-color: var(--primary-500);
  animation: spin 1.2s linear infinite;
}

/* ===== VARIANT MINI CARD ===== */
.variant-card {
  padding: 16px; border-radius: 12px;
  border: 1px solid rgba(26,31,60,0.4);
  background: rgba(13,17,40,0.4);
  font-size: 13px; line-height: 1.5; color: rgba(232,234,246,0.6);
}
.variant-card__meta {
  display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;
}
.variant-card__tag {
  font-size: 10px; padding: 3px 8px; border-radius: 6px;
  background: rgba(0,212,255,0.06); border: 1px solid rgba(0,212,255,0.15);
  color: var(--primary-300); font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* ===== ANIMATIONS ===== */
@keyframes fade-up {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fade-in {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes pulse-glow {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 0.8; }
}
@keyframes loading-pulse {
  0%, 100% { transform: scale(0.8); opacity: 0.4; }
  50% { transform: scale(1.1); opacity: 0.8; }
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

.anim-fade-up { animation: fade-up 0.6s ease-out both; }
.anim-delay-1 { animation-delay: 100ms; }
.anim-delay-2 { animation-delay: 200ms; }
.anim-delay-3 { animation-delay: 300ms; }
.anim-delay-4 { animation-delay: 400ms; }
.anim-delay-5 { animation-delay: 500ms; }

/* ===== VIEW SYSTEM ===== */
.view { display: none; }
.view--active { display: block; }

/* ===== CREDITS BAR ===== */
.credits-bar {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 20px; border-radius: 12px;
  background: linear-gradient(145deg, rgba(139,92,246,0.08) 0%, rgba(13,17,40,0.4) 100%);
  border: 1px solid rgba(139,92,246,0.2);
  margin-bottom: 24px;
}
.credits-bar__icon {
  width: 36px; height: 36px; border-radius: 10px;
  background: rgba(139,92,246,0.12); display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.credits-bar__text {
  font-size: 13px; color: rgba(232,234,246,0.6);
}
.credits-bar__count {
  font-family: var(--font-display); font-weight: 700; font-size: 15px;
  color: var(--electric-purple);
}
.credits-bar__unlimited {
  font-family: var(--font-display); font-weight: 700; font-size: 15px;
  color: var(--primary-400);
}

/* ===== LANDING GALLERY ===== */
.gallery-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;
  max-width: 1000px; margin: 0 auto;
}
@media (max-width: 768px) {
  .gallery-grid { grid-template-columns: 1fr; max-width: 400px; }
}
.gallery-card {
  border-radius: 16px; overflow: hidden;
  border: 1px solid rgba(26,31,60,0.5);
  background: linear-gradient(145deg, rgba(13,17,40,0.7) 0%, rgba(6,9,24,0.9) 100%);
  transition: all 0.4s ease;
}
.gallery-card:hover {
  border-color: rgba(0,212,255,0.25);
  transform: translateY(-4px);
  box-shadow: 0 16px 48px rgba(0,0,0,0.4), 0 0 40px rgba(0,212,255,0.06);
}
.gallery-card__type {
  padding: 10px 16px;
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.08em; color: var(--primary-400);
  border-bottom: 1px solid rgba(26,31,60,0.4);
}
.gallery-card__body {
  padding: 20px;
  font-size: 13px; line-height: 1.65;
  color: rgba(232,234,246,0.65);
  max-height: 280px; overflow: hidden;
  position: relative;
}
.gallery-card__body::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0; height: 60px;
  background: linear-gradient(transparent, rgba(6,9,24,0.95));
  pointer-events: none;
}
.gallery-card__footer {
  padding: 12px 16px;
  display: flex; gap: 8px; flex-wrap: wrap;
  border-top: 1px solid rgba(26,31,60,0.3);
}
.gallery-tag {
  font-size: 10px; padding: 3px 8px; border-radius: 6px;
  background: rgba(0,212,255,0.06); border: 1px solid rgba(0,212,255,0.15);
  color: var(--primary-300); font-weight: 600;
}

/* ===== ACCESS REQUEST VIEWS ===== */
.access-view {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; text-align: center;
  padding: 80px 24px; min-height: 50vh;
}
.access-view__icon {
  width: 80px; height: 80px; border-radius: 20px;
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 24px;
}
.access-view__icon--request {
  background: linear-gradient(135deg, rgba(0,212,255,0.12) 0%, rgba(139,92,246,0.08) 100%);
  border: 1px solid rgba(0,212,255,0.2);
}
.access-view__icon--pending {
  background: linear-gradient(135deg, rgba(245,158,11,0.12) 0%, rgba(245,158,11,0.06) 100%);
  border: 1px solid rgba(245,158,11,0.2);
}
.access-view__icon--rejected {
  background: linear-gradient(135deg, rgba(239,68,68,0.12) 0%, rgba(239,68,68,0.06) 100%);
  border: 1px solid rgba(239,68,68,0.2);
}
.access-view__title {
  font-family: var(--font-display); font-size: 28px; font-weight: 700;
  color: #fff; margin-bottom: 12px;
}
.access-view__desc {
  font-size: 15px; line-height: 1.6; color: rgba(232,234,246,0.5);
  max-width: 400px; margin-bottom: 32px;
}

/* ===== HIDE/SHOW ===== */
.hidden { display: none !important; }

/* ===== RESPONSIVE HELPERS ===== */
.scores-grid {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;
}
@media (max-width: 700px) {
  .scores-grid { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 440px) {
  .scores-grid { grid-template-columns: repeat(2, 1fr); }
}

.results-grid {
  display: grid; grid-template-columns: 1fr 340px; gap: 24px;
}
@media (max-width: 800px) {
  .results-grid { grid-template-columns: 1fr; }
}

/* ===== COST TABLE ===== */
.cost-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  margin-top: 12px;
}
.cost-table th, .cost-table td {
  padding: 10px 12px;
  text-align: left;
  border-bottom: 1px solid rgba(26,31,60,0.4);
}
.cost-table th {
  color: rgba(232,234,246,0.5);
  font-weight: 600;
  text-transform: uppercase;
  font-size: 10px;
  letter-spacing: 0.05em;
}
.cost-table td {
  color: rgba(232,234,246,0.7);
}
.cost-table tbody tr:hover {
  background: rgba(0,212,255,0.03);
}
.cost-table tfoot td {
  border-top: 2px solid rgba(0,212,255,0.2);
  border-bottom: none;
  color: var(--primary-300);
}

/* ===== TIMING TABLE ===== */
.timing-bar {
  height: 8px;
  border-radius: 4px;
  background: linear-gradient(90deg, var(--primary-500) 0%, var(--primary-700) 100%);
  transition: width 0.4s ease;
  min-width: 2px;
}
.timing-bar--slow {
  background: linear-gradient(90deg, var(--accent) 0%, var(--electric-pink) 100%);
}
.timing-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  margin-top: 12px;
}
.timing-table th, .timing-table td {
  padding: 10px 12px;
  text-align: left;
  border-bottom: 1px solid rgba(26,31,60,0.4);
}
.timing-table th {
  color: rgba(232,234,246,0.5);
  font-weight: 600;
  text-transform: uppercase;
  font-size: 10px;
  letter-spacing: 0.05em;
}
.timing-table td {
  color: rgba(232,234,246,0.7);
}
.timing-table tbody tr:hover {
  background: rgba(0,212,255,0.03);
}
.timing-table tfoot td {
  border-top: 2px solid rgba(0,212,255,0.2);
  border-bottom: none;
  color: var(--primary-300);
}

/* ===== FOOTER ===== */
footer {
  padding: 48px 0; text-align: center;
  font-size: 13px; color: rgba(232,234,246,0.25);
}
footer a {
  color: var(--primary-400); text-decoration: none;
  transition: color 0.2s;
}
footer a:hover { color: var(--primary-300); }

/* ===== RESULTS SECTIONS ===== */
.results-section-flow {
  display: flex; flex-direction: column; gap: 24px;
}

.result-section {
  position: relative;
}

.result-section__label {
  display: inline-flex; align-items: center; gap: 8px;
  font-size: 11px; font-weight: 600; color: rgba(232,234,246,0.35);
  text-transform: uppercase; letter-spacing: 0.08em;
  margin-bottom: 12px;
}

.result-section__label::before {
  content: '';
  width: 3px; height: 12px;
  background: linear-gradient(180deg, var(--primary-500) 0%, var(--primary-700) 100%);
  border-radius: 2px;
}

/* ===== CAROUSEL PREVIEW (larger) ===== */
.carousel-preview-wrap {
  position: relative;
  width: 100%;
  max-width: 480px;
  margin: 0 auto;
}

.carousel-preview-container {
  width: 100%;
  aspect-ratio: 1;
  border-radius: 16px;
  background: var(--surface-muted);
  border: 1px solid var(--surface-border);
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s ease;
}

.carousel-preview-container:hover {
  border-color: rgba(0,212,255,0.3);
  box-shadow: 0 8px 40px rgba(0,0,0,0.4), 0 0 40px rgba(0,212,255,0.1);
}

.carousel-preview-overlay {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  background: rgba(6,9,24,0.6);
  opacity: 0; transition: opacity 0.3s;
  border-radius: 16px;
  pointer-events: none;
}

.carousel-preview-container:hover + .carousel-preview-overlay,
.carousel-preview-wrap:hover .carousel-preview-overlay {
  opacity: 1;
}

.expand-hint {
  display: flex; align-items: center; gap: 8px;
  padding: 12px 20px; border-radius: 999px;
  background: rgba(0,212,255,0.15);
  border: 1px solid rgba(0,212,255,0.3);
  color: var(--primary-300);
  font-size: 13px; font-weight: 600;
}

/* ===== CAROUSEL MODAL ===== */
.carousel-modal {
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(6, 9, 24, 0.97);
  backdrop-filter: blur(24px);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  opacity: 0; visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.carousel-modal--open {
  opacity: 1; visibility: visible;
}

.carousel-modal__header {
  position: absolute; top: 0; left: 0; right: 0;
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 32px;
}

.carousel-modal__close {
  display: flex; align-items: center; justify-content: center;
  width: 44px; height: 44px; border-radius: 12px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  color: rgba(232,234,246,0.7);
  cursor: pointer; transition: all 0.2s;
}

.carousel-modal__close:hover {
  background: rgba(255,255,255,0.1);
  color: #fff;
}

.carousel-modal__content {
  display: flex; align-items: center; gap: 24px;
  max-width: 90vw; max-height: 80vh;
}

.carousel-modal__nav {
  display: flex; align-items: center; justify-content: center;
  width: 56px; height: 56px; border-radius: 50%;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  color: rgba(232,234,246,0.7);
  cursor: pointer; transition: all 0.2s;
  flex-shrink: 0;
}

.carousel-modal__nav:hover {
  background: rgba(0,212,255,0.15);
  border-color: rgba(0,212,255,0.3);
  color: var(--primary-300);
}

.carousel-modal__nav:disabled {
  opacity: 0.3; cursor: not-allowed;
}

.carousel-modal__slide-wrap {
  width: min(70vw, 600px);
  aspect-ratio: 1;
  border-radius: 20px;
  background: var(--surface-muted);
  border: 1px solid var(--surface-border);
  overflow: hidden;
  box-shadow: 0 24px 80px rgba(0,0,0,0.6);
}

.carousel-modal__slide-wrap iframe {
  width: 100%; height: 100%; border: none;
}

.carousel-modal__dots {
  display: flex; gap: 10px;
  margin-top: 24px;
}

.carousel-modal__dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: rgba(255,255,255,0.2);
  border: none; cursor: pointer;
  transition: all 0.2s;
}

.carousel-modal__dot--active {
  background: var(--primary-500);
  box-shadow: 0 0 12px rgba(0,212,255,0.5);
}

.carousel-modal__dot:hover:not(.carousel-modal__dot--active) {
  background: rgba(255,255,255,0.4);
}

/* ===== VARIANTS GRID ===== */
.variants-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

@media (max-width: 900px) {
  .variants-grid { grid-template-columns: 1fr; }
}

.variant-card--full {
  position: relative;
  padding: 20px;
  border-radius: 14px;
  border: 1px solid rgba(26,31,60,0.5);
  background: linear-gradient(145deg, rgba(13,17,40,0.6) 0%, rgba(6,9,24,0.8) 100%);
  transition: all 0.3s ease;
}

.variant-card--full:hover {
  border-color: rgba(0,212,255,0.2);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.variant-card__header {
  display: flex; align-items: flex-start; justify-content: space-between;
  gap: 12px; margin-bottom: 12px;
}

.variant-card__number {
  font-family: var(--font-display);
  font-size: 11px; font-weight: 700;
  color: rgba(0,212,255,0.5);
  padding: 4px 10px;
  border-radius: 6px;
  background: rgba(0,212,255,0.08);
  border: 1px solid rgba(0,212,255,0.15);
}

.variant-card__copy {
  display: flex; align-items: center; gap: 4px;
  padding: 6px 12px; border-radius: 6px;
  border: 1px solid rgba(26,31,60,0.6);
  background: rgba(13,17,40,0.5);
  color: rgba(232,234,246,0.5);
  font-size: 11px; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
  font-family: var(--font-body);
}

.variant-card__copy:hover {
  border-color: rgba(0,212,255,0.3);
  color: var(--primary-300);
}

.variant-card__copy--copied {
  border-color: #10b981;
  color: #10b981;
}

.variant-card__content {
  font-size: 14px;
  line-height: 1.65;
  color: rgba(232,234,246,0.75);
  white-space: pre-wrap;
  word-wrap: break-word;
  max-height: 400px;
  overflow-y: auto;
}

.variant-card__content::-webkit-scrollbar {
  width: 4px;
}

.variant-card__content::-webkit-scrollbar-thumb {
  background: rgba(0,212,255,0.2);
  border-radius: 2px;
}

.variant-card__footer {
  display: flex; gap: 8px; margin-top: 14px;
  padding-top: 14px; border-top: 1px solid rgba(26,31,60,0.4);
  flex-wrap: wrap;
}

/* ===== CAROUSEL CARD IN FLOW ===== */
.carousel-section-card {
  padding: 28px;
  border-radius: 16px;
  border: 1px solid rgba(26,31,60,0.5);
  background: linear-gradient(145deg, rgba(13,17,40,0.6) 0%, rgba(6,9,24,0.8) 100%);
}

.carousel-section__header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px; flex-wrap: wrap; gap: 12px;
}

.carousel-section__title {
  font-family: var(--font-display);
  font-weight: 700; font-size: 18px;
  color: #fff;
}

.carousel-section__subtitle {
  font-size: 12px;
  color: rgba(232,234,246,0.4);
  margin-top: 2px;
}

.carousel-actions {
  display: flex; gap: 10px; flex-wrap: wrap;
}

/* Auth Modal */
.auth-modal {
  position: fixed; inset: 0; z-index: 100;
  display: none; align-items: center; justify-content: center;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(8px);
}
.auth-modal--open { display: flex; }
.auth-modal__card {
  width: 100%; max-width: 400px; margin: 16px;
  padding: 32px; border-radius: 16px;
  background: linear-gradient(145deg, rgba(13,17,40,0.95) 0%, rgba(6,9,24,0.98) 100%);
  border: 1px solid rgba(26,31,60,0.6);
  box-shadow: 0 24px 48px rgba(0,0,0,0.4);
}
.auth-modal__title {
  font-family: var(--font-display); font-size: 24px; font-weight: 700;
  color: #fff; margin-bottom: 8px; text-align: center;
}
.auth-modal__subtitle {
  font-size: 14px; color: rgba(232,234,246,0.5);
  text-align: center; margin-bottom: 24px;
}
.auth-btn {
  width: 100%; display: flex; align-items: center; justify-content: center; gap: 12px;
  padding: 14px 20px; margin-bottom: 12px;
  border-radius: 12px; border: 1px solid var(--surface-border);
  background: rgba(13,17,40,0.5);
  color: var(--surface-foreground); font-size: 15px; font-weight: 600;
  cursor: pointer; transition: all 0.3s ease;
}
.auth-btn:hover {
  border-color: rgba(0,212,255,0.4);
  background: rgba(0,212,255,0.08);
}
.auth-btn--google { background: #fff; color: #333; border-color: #ddd; }
.auth-btn--google:hover { background: #f5f5f5; border-color: #ccc; }
.auth-btn--microsoft { background: #2f2f2f; color: #fff; border-color: #444; }
.auth-btn--microsoft:hover { background: #404040; border-color: #555; }
.auth-divider {
  display: flex; align-items: center; gap: 12px;
  margin: 20px 0; color: rgba(232,234,246,0.3); font-size: 12px;
}
.auth-divider::before, .auth-divider::after {
  content: ''; flex: 1; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(232,234,246,0.2), transparent);
}
.auth-error {
  display: none; padding: 12px; margin-top: 16px;
  border-radius: 8px; background: rgba(239,68,68,0.1);
  border: 1px solid rgba(239,68,68,0.3);
  color: #ef4444; font-size: 13px; text-align: center;
}
.auth-error--visible { display: block; }
.user-badge {
  display: flex; align-items: center; gap: 10px;
  padding: 6px 12px; border-radius: 999px;
  background: rgba(13,17,40,0.5);
  border: 1px solid rgba(26,31,60,0.6);
}
.user-badge__name {
  font-size: 13px; color: rgba(232,234,246,0.7);
  max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.user-badge__logout {
  padding: 4px 10px; border-radius: 999px;
  background: transparent; border: 1px solid rgba(232,234,246,0.2);
  color: rgba(232,234,246,0.6); font-size: 11px; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.user-badge__logout:hover {
  border-color: rgba(236,72,153,0.5); color: #ec4899;
}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
</head>
<body>

<!-- Texture layers -->
<div class="noise-overlay"></div>
<div class="grid-bg"></div>

<!-- ===== HEADER ===== -->
<header style="position:sticky;top:0;z-index:50;padding:16px 0;background:rgba(6,9,24,0.8);backdrop-filter:blur(16px);border-bottom:1px solid rgba(26,31,60,0.4);">
  <div class="shell" style="display:flex;align-items:center;justify-content:space-between;">
    <div style="display:flex;align-items:center;gap:12px;">
      <img src="/static/logo.png" alt="AFTA" style="height:72px;width:auto;">
      <span style="font-size:13px;font-weight:500;color:rgba(232,234,246,0.4);">Marketing for LinkedIn</span>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <!-- Auth button (shown when not logged in) -->
      <button id="auth-btn" onclick="openAuthModal()" class="btn-ghost" style="padding:8px 16px;font-size:12px;display:none;">
        Sign In
      </button>
      <!-- User badge (shown when logged in) -->
      <div id="user-badge" class="user-badge" style="display:none;">
        <span id="user-name" class="user-badge__name"></span>
        <button onclick="handleLogout()" class="user-badge__logout">Sign Out</button>
      </div>
      <a href="https://afta.systems" target="_blank" class="btn-ghost" style="padding:8px 16px;font-size:12px;">
        afta.systems
        <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
      </a>
    </div>
  </div>
</header>

<!-- ===== VIEW: LANDING (public) ===== -->
<div id="view-landing" class="view view--active">
<section style="padding:80px 0 60px;position:relative;overflow:hidden;">
  <div class="glow-orb glow-orb--cyan" style="width:600px;height:600px;top:-200px;right:-200px;opacity:0.25;"></div>
  <div class="glow-orb glow-orb--purple" style="width:400px;height:400px;bottom:-100px;left:-150px;opacity:0.15;"></div>

  <div class="shell" style="position:relative;z-index:1;text-align:center;">
    <div class="badge anim-fade-up" style="margin-bottom:24px;">
      <span class="badge__dot"></span>
      AI-Powered Content Engine
    </div>

    <h1 class="heading-display anim-fade-up anim-delay-1" style="font-size:clamp(36px,6vw,64px);color:#fff;margin-bottom:20px;max-width:700px;margin-left:auto;margin-right:auto;">
      Create LinkedIn Content That
      <span class="heading-gradient">Stops the Scroll</span>
    </h1>

    <p class="anim-fade-up anim-delay-2" style="font-size:18px;line-height:1.6;color:rgba(232,234,246,0.6);max-width:540px;margin-bottom:40px;margin-left:auto;margin-right:auto;">
      AI-powered post generation and branded carousel creation.
      Your voice. Your brand. Zero slop.
    </p>

    <button onclick="handleLandingCTA()" class="btn-primary btn-primary--lg anim-fade-up anim-delay-2" style="margin-bottom:48px;">
      <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
      Get Started Free
    </button>

    <!-- Promo video -->
    <div class="promo-video-wrap anim-fade-up anim-delay-3" style="max-width:720px;margin-left:auto;margin-right:auto;">
      <video autoplay muted loop playsinline preload="auto">
        <source src="/static/promo.mp4" type="video/mp4">
      </video>
    </div>
  </div>
</section>

<div class="shell"><div class="section-divider"></div></div>

<!-- Examples Gallery -->
<section style="padding:60px 0;">
  <div class="shell" style="text-align:center;">
    <h2 class="heading-display anim-fade-up" style="font-size:28px;color:#fff;margin-bottom:8px;">See What It Creates</h2>
    <p class="anim-fade-up anim-delay-1" style="font-size:15px;color:rgba(232,234,246,0.45);margin-bottom:40px;">Real examples generated by our multi-agent pipeline</p>

    <div class="gallery-grid anim-fade-up anim-delay-2">
      <!-- Example 1: LinkedIn Post - Professional -->
      <div class="gallery-card">
        <div class="gallery-card__type">LinkedIn Post</div>
        <div class="gallery-card__body">
          I analyzed 47 failed automation projects last quarter. One pattern showed up in 43 of them.<br><br>
          The founders didn't fail at picking tools. They failed at mapping their actual process first.<br><br>
          They jumped straight to Zapier/Make/n8n and tried to automate what they thought they were doing. Not what they were actually doing.<br><br>
          The 4 that succeeded? They spent 2 weeks documenting every manual step before writing a single automation.
        </div>
        <div class="gallery-card__footer">
          <span class="gallery-tag">Professional</span>
          <span class="gallery-tag">Data Hook</span>
        </div>
      </div>

      <!-- Example 2: LinkedIn Post - Witty -->
      <div class="gallery-card">
        <div class="gallery-card__type">LinkedIn Post</div>
        <div class="gallery-card__body">
          Me at 2 AM: "I'll just manually update these 200 SKUs real quick."<br><br>
          Me at 4 AM: still updating SKUs, questioning every life decision that led here.<br><br>
          Me at 9 AM: discovers the CSV import button that's been there since 2019.<br><br>
          This is roughly what happens when e-commerce operators try to scale without automation. You don't need more coffee. You need fewer manual steps.
        </div>
        <div class="gallery-card__footer">
          <span class="gallery-tag">Witty</span>
          <span class="gallery-tag">Story Hook</span>
        </div>
      </div>

      <!-- Example 3: Carousel -->
      <div class="gallery-card">
        <div class="gallery-card__type">Branded Carousel</div>
        <div class="gallery-card__body" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:240px;">
          <div style="width:100%;aspect-ratio:1;max-width:220px;border-radius:12px;background:linear-gradient(135deg, rgba(0,212,255,0.08) 0%, rgba(139,92,246,0.06) 100%);border:1px solid rgba(0,212,255,0.15);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;">
            <svg width="40" height="40" fill="none" stroke="var(--primary-400)" viewBox="0 0 24 24" style="opacity:0.6;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span style="font-size:12px;color:rgba(232,234,246,0.4);">5-slide branded carousel</span>
            <span style="font-size:11px;color:rgba(0,212,255,0.5);">Auto-generated from post</span>
          </div>
        </div>
        <div class="gallery-card__footer">
          <span class="gallery-tag">Carousel</span>
          <span class="gallery-tag">AFTA Brand</span>
        </div>
      </div>
    </div>

    <button onclick="handleLandingCTA()" class="btn-primary anim-fade-up anim-delay-3" style="margin-top:40px;">
      Try It Now
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
    </button>
  </div>
</section>

<div class="shell"><div class="section-divider"></div></div>

<footer>
  <div class="shell" style="display:flex;flex-direction:column;align-items:center;gap:16px;">
    <img src="/static/logo.png" alt="AFTA" style="height:48px;width:auto;">
    <div>Powered by <a href="https://afta.systems" target="_blank">AFTA Systems</a> &middot; AI Automation for E-commerce</div>
  </div>
</footer>
</div>

<!-- ===== VIEW: REQUEST ACCESS ===== -->
<div id="view-request-access" class="view">
  <div class="access-view">
    <div class="access-view__icon access-view__icon--request">
      <svg width="36" height="36" fill="none" stroke="var(--primary-400)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
    </div>
    <div class="access-view__title">Request Access</div>
    <div class="access-view__desc">
      You're signed in! Request access to start generating LinkedIn content with 3 free generations.
    </div>
    <button onclick="handleRequestAccess()" class="btn-primary btn-primary--lg" id="request-access-btn">
      <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
      Request Access
    </button>
  </div>
</div>

<!-- ===== VIEW: PENDING ===== -->
<div id="view-pending" class="view">
  <div class="access-view">
    <div class="access-view__icon access-view__icon--pending">
      <svg width="36" height="36" fill="none" stroke="var(--accent)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
    </div>
    <div class="access-view__title">Access Request Pending</div>
    <div class="access-view__desc">
      Your request has been submitted and is being reviewed. You'll get access once approved.
    </div>
    <div style="font-size:13px;color:rgba(232,234,246,0.3);">Check back soon or refresh this page.</div>
  </div>
</div>

<!-- ===== VIEW: REJECTED ===== -->
<div id="view-rejected" class="view">
  <div class="access-view">
    <div class="access-view__icon access-view__icon--rejected">
      <svg width="36" height="36" fill="none" stroke="#ef4444" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
    </div>
    <div class="access-view__title">Access Not Approved</div>
    <div class="access-view__desc">
      Your access request was not approved. If you believe this is an error, please contact us.
    </div>
    <a href="mailto:dd.petrovskiy@gmail.com" class="btn-ghost">
      <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
      Contact Admin
    </a>
  </div>
</div>

<!-- ===== VIEW: DASHBOARD (approved users) ===== -->
<div id="view-dashboard" class="view">
<section id="generate" style="padding:60px 0 40px;">
  <div class="shell">
    <!-- Credits Bar -->
    <div id="credits-bar" class="credits-bar hidden">
      <div class="credits-bar__icon">
        <svg width="18" height="18" fill="none" stroke="var(--electric-purple)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
      </div>
      <div class="credits-bar__text">
        <span id="credits-count"></span>
      </div>
    </div>

    <div id="form-section">
      <h2 class="heading-display" style="font-size:28px;color:#fff;margin-bottom:32px;">
        Generate Marketing Materials
      </h2>

      <div class="card" style="padding:32px;">
        <div style="display:flex;flex-direction:column;gap:28px;">

          <!-- Target Website -->
          <div>
            <label class="form-label">Target Website</label>
            <div class="url-input-wrap">
              <input id="target-url" type="url" class="form-input" value="https://afta.systems" autocomplete="url">
              <div id="logo-preview" class="logo-preview">
                <svg width="20" height="20" fill="none" stroke="rgba(232,234,246,0.2)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
              </div>
            </div>
            <p class="form-hint">We'll generate a company profile and tailor content to this company's audience.</p>

            <!-- Company profile card (shown after generation or for default) -->
            <div id="company-profile-card" class="hidden" style="margin-top:12px;">
              <div class="card" style="padding:14px 16px;background:linear-gradient(145deg, rgba(139,92,246,0.06) 0%, rgba(13,17,40,0.4) 100%);border:1px solid rgba(139,92,246,0.15);">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                  <svg width="14" height="14" fill="none" stroke="var(--electric-purple)" viewBox="0 0 24 24" style="flex-shrink:0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  <div id="profile-badge" style="font-size:10px;font-weight:600;color:rgba(139,92,246,0.7);text-transform:uppercase;letter-spacing:0.05em;">Company Profile</div>
                </div>
                <div id="profile-name" style="font-family:var(--font-display);font-size:15px;font-weight:700;color:#fff;margin-bottom:2px;"></div>
                <div id="profile-tagline" style="font-size:12px;color:rgba(232,234,246,0.5);margin-bottom:10px;"></div>
                <button class="collapsible__trigger" onclick="toggleCollapsible('profile-details')" style="padding:6px 0;font-size:11px;">
                  <svg width="10" height="10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                  Details
                </button>
                <div id="profile-details" class="collapsible__body">
                  <div style="display:flex;flex-direction:column;gap:8px;padding:6px 0;font-size:11px;color:rgba(232,234,246,0.6);">
                    <div><strong style="color:rgba(232,234,246,0.8);">Core Offering:</strong> <span id="profile-offering"></span></div>
                    <div><strong style="color:rgba(232,234,246,0.8);">Differentiator:</strong> <span id="profile-diff"></span></div>
                    <div><strong style="color:rgba(232,234,246,0.8);">Target Audience:</strong> <span id="profile-audience"></span></div>
                    <div><strong style="color:rgba(232,234,246,0.8);">Key Services:</strong> <span id="profile-services"></span></div>
                    <div><strong style="color:rgba(232,234,246,0.8);">Proof Points:</strong> <span id="profile-proof"></span></div>
                    <div><strong style="color:rgba(232,234,246,0.8);">Pain Points:</strong> <span id="profile-pains"></span></div>
                    <div><strong style="color:rgba(232,234,246,0.8);">Keywords:</strong> <span id="profile-keywords"></span></div>
                  </div>
                </div>
                <div id="profile-stats" class="hidden" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(139,92,246,0.1);display:flex;gap:14px;font-size:10px;color:rgba(232,234,246,0.35);">
                  <span><span style="color:rgba(139,92,246,0.5);">Model:</span> <span id="profile-model"></span></span>
                  <span><span style="color:rgba(139,92,246,0.5);">Tokens:</span> <span id="profile-tokens"></span></span>
                  <span><span style="color:rgba(139,92,246,0.5);">Cost:</span> $<span id="profile-cost"></span></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Message -->
          <div>
            <label class="form-label">Message</label>
            <textarea id="message" class="form-textarea" rows="2" placeholder="What message should be conveyed? Leave empty to use source summary"></textarea>
            <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
              <input type="checkbox" id="auto-summarize" checked
                     style="width:16px;height:16px;accent-color:var(--primary-500);cursor:pointer;">
              <label for="auto-summarize" style="font-size:12px;color:rgba(232,234,246,0.5);cursor:pointer;">
                Auto-summarize when empty <span style="color:rgba(232,234,246,0.3);">(uses Claude Sonnet to extract key message)</span>
              </label>
            </div>
          </div>

          <!-- Source -->
          <div>
            <label class="form-label">Source Content</label>
            <div class="source-toggle" style="margin-bottom:12px;">
              <button id="source-auto-btn" class="source-toggle__btn source-toggle__btn--active" type="button" onclick="setSourceMode('auto')">Auto-fetch News</button>
              <button id="source-paste-btn" class="source-toggle__btn" type="button" onclick="setSourceMode('paste')">Paste Text</button>
            </div>
            <div id="source-auto" class="auto-fetch-card">
              <div class="auto-fetch-card__icon">
                <svg width="20" height="20" fill="none" stroke="var(--primary-400)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
              </div>
              <div>
                <div style="font-size:14px;font-weight:600;color:rgba(232,234,246,0.8);margin-bottom:2px;">Automatic Source</div>
                <div style="font-size:12px;color:rgba(232,234,246,0.4);">We'll find the most relevant recent news article and use it as source material</div>
              </div>
            </div>
            <textarea id="source-paste" class="form-textarea hidden" rows="5" placeholder="Paste your blog post, news article, or any text here..."></textarea>
          </div>

          <!-- Persona -->
          <div>
            <label class="form-label">Choose Your Voice</label>
            <div id="persona-grid" class="persona-grid">
              <!-- Populated by JS -->
            </div>
          </div>

          <!-- Advanced Settings Row -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
            <!-- Number of Generators -->
            <div>
              <label class="form-label">Number of Samples</label>
              <div style="display:flex;align-items:center;gap:12px;">
                <input type="range" id="num-generators" min="3" max="10" value="5"
                       style="flex:1;accent-color:var(--primary-500);height:6px;cursor:pointer;"
                       oninput="document.getElementById('num-gen-value').textContent = this.value">
                <span id="num-gen-value" style="font-family:var(--font-display);font-size:20px;font-weight:700;color:var(--primary-300);min-width:24px;text-align:center;">5</span>
              </div>
              <p class="form-hint">More samples = better results, but slower (3-10)</p>
            </div>

            <!-- Model Selection -->
            <div>
              <label class="form-label">Generation Model</label>
              <select id="generation-model" class="form-input" style="cursor:pointer;">
                <!-- Populated by JS -->
              </select>
              <p class="form-hint">Used for both generation and judging.</p>
            </div>
          </div>

          <!-- Submit -->
          <button id="generate-btn" class="btn-primary btn-primary--lg btn-primary--full" onclick="handleGenerate()">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            Generate Content
          </button>

        </div>
      </div>
    </div>

    <!-- LOADING STATE -->
    <div id="loading-section" class="hidden">
      <div class="loading-overlay">
        <div class="loading-orb"></div>
        <div>
          <div style="font-family:var(--font-display);font-size:20px;font-weight:700;color:#fff;margin-bottom:8px;">Generating your content...</div>
          <div id="loading-persona" style="font-size:14px;color:rgba(232,234,246,0.4);"></div>
        </div>
      </div>
    </div>

    <!-- RESULTS SECTION -->
    <div id="results-section" class="hidden">
      <!-- Header -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;flex-wrap:wrap;gap:12px;">
        <h2 class="heading-display" style="font-size:28px;color:#fff;">Results</h2>
        <button class="btn-ghost" onclick="resetToForm()">
          <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          Generate Again
        </button>
      </div>

      <div class="results-section-flow">

        <!-- SECTION 1: Company Profile -->
        <div class="result-section">
          <div class="result-section__label">Company Context</div>
          <div id="result-company-card" class="card" style="padding:16px 20px;background:linear-gradient(145deg, rgba(139,92,246,0.06) 0%, rgba(13,17,40,0.4) 100%);border:1px solid rgba(139,92,246,0.15);">
            <div style="display:flex;align-items:center;gap:10px;">
              <svg width="16" height="16" fill="none" stroke="var(--electric-purple)" viewBox="0 0 24 24" style="flex-shrink:0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              <div id="result-company-badge" style="font-size:10px;font-weight:600;color:rgba(139,92,246,0.7);text-transform:uppercase;letter-spacing:0.05em;">Company Profile</div>
              <div style="flex:1;"></div>
              <button class="collapsible__trigger" onclick="toggleCollapsible('result-company-details')" style="padding:4px 0;font-size:11px;margin:0;">
                <svg width="10" height="10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                Details
              </button>
            </div>
            <div style="display:flex;align-items:baseline;gap:10px;margin-top:6px;">
              <div id="result-company-name" style="font-family:var(--font-display);font-size:16px;font-weight:700;color:#fff;"></div>
              <div id="result-company-tagline" style="font-size:12px;color:rgba(232,234,246,0.45);"></div>
            </div>
            <div id="result-company-details" class="collapsible__body">
              <div style="display:flex;flex-direction:column;gap:6px;padding:10px 0 2px;font-size:11px;color:rgba(232,234,246,0.55);">
                <div><strong style="color:rgba(232,234,246,0.75);">Core Offering:</strong> <span id="result-cp-offering"></span></div>
                <div><strong style="color:rgba(232,234,246,0.75);">Differentiator:</strong> <span id="result-cp-diff"></span></div>
                <div><strong style="color:rgba(232,234,246,0.75);">Target Audience:</strong> <span id="result-cp-audience"></span></div>
                <div><strong style="color:rgba(232,234,246,0.75);">Key Services:</strong> <span id="result-cp-services"></span></div>
                <div><strong style="color:rgba(232,234,246,0.75);">Pain Points:</strong> <span id="result-cp-pains"></span></div>
                <div><strong style="color:rgba(232,234,246,0.75);">Keywords:</strong> <span id="result-cp-keywords"></span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION 2: Source Article -->
        <div class="result-section">
          <div class="result-section__label">Source Material</div>
          <div id="source-article-card" class="card" style="padding:20px 24px;background:linear-gradient(145deg, rgba(245,158,11,0.06) 0%, rgba(13,17,40,0.4) 100%);border:1px solid rgba(245,158,11,0.15);">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color:var(--accent-light);flex-shrink:0;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
              </svg>
              <div style="font-size:11px;font-weight:600;color:rgba(245,158,11,0.7);text-transform:uppercase;letter-spacing:0.05em;">Source Article</div>
              <div style="flex:1;"></div>
              <div style="display:flex;gap:8px;">
                <span id="result-source-tag" style="font-size:11px;padding:4px 10px;border-radius:6px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.25);color:var(--accent-light);"></span>
                <span id="result-persona-name" style="font-size:11px;padding:4px 10px;border-radius:6px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.25);color:var(--electric-purple);"></span>
              </div>
            </div>
            <div id="result-source-title" style="font-family:var(--font-display);font-size:17px;font-weight:600;color:#fff;line-height:1.4;margin-bottom:10px;"></div>
            <div id="result-source-summary-preview" style="font-size:14px;line-height:1.6;color:rgba(232,234,246,0.55);"></div>
            <div id="result-source-summary-full" class="collapsible__body" style="font-size:14px;line-height:1.6;color:rgba(232,234,246,0.55);"></div>
            <button id="source-expand-btn" class="collapsible__trigger" onclick="toggleSourceExpand()" style="padding:8px 0 0 0;font-size:12px;color:rgba(245,158,11,0.6);">
              <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              <span id="source-expand-text">Show full article</span>
            </button>
          </div>
        </div>

        <!-- SECTION 3: Winning Post -->
        <div class="result-section">
          <div class="result-section__label">Generated Post</div>
          <div class="winner-card">
            <div class="winner-card__header">
              <div style="display:flex;align-items:center;gap:12px;">
                <div class="badge">
                  <span class="badge__dot"></span>
                  Winning Post
                </div>
                <div id="result-score" class="score-circle"></div>
              </div>
              <button id="copy-btn" class="copy-btn" onclick="copyWinner()">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" stroke-width="1.5"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" stroke-width="1.5"/></svg>
                Copy
              </button>
            </div>
            <div id="result-post" class="winner-card__content"></div>

            <!-- Score breakdown inside winner card -->
            <div style="margin-top:24px;padding-top:20px;border-top:1px solid rgba(0,212,255,0.1);">
              <div style="font-size:12px;font-weight:600;color:rgba(232,234,246,0.4);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.05em;">Score Breakdown</div>
              <div id="scores-grid" class="scores-grid"></div>
            </div>
          </div>
        </div>

        <!-- SECTION 4: LinkedIn Carousel -->
        <div class="result-section">
          <div class="result-section__label">Visual Content</div>
          <div class="carousel-section-card">
            <div class="carousel-section__header">
              <div>
                <div class="carousel-section__title">LinkedIn Carousel</div>
                <div class="carousel-section__subtitle">5-slide branded carousel</div>
              </div>
              <div class="carousel-actions">
                <button class="btn-ghost" onclick="openCarouselModal()">
                  <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                  Expand
                </button>
                <a id="carousel-download" class="btn-primary" href="#" download style="text-decoration:none;">
                  <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  Download HTML
                </a>
              </div>
            </div>
            <div class="carousel-preview-wrap">
              <div class="carousel-preview-container" onclick="openCarouselModal()">
                <iframe id="carousel-iframe" style="width:100%;height:100%;border:none;pointer-events:none;" title="Carousel preview"></iframe>
              </div>
              <div class="carousel-preview-overlay">
                <div class="expand-hint">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                  Click to expand
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION 5: All Variants -->
        <div class="result-section">
          <div class="result-section__label">Alternative Versions</div>
          <div class="card" style="padding:20px 24px;">
            <button class="collapsible__trigger" onclick="toggleCollapsible('all-variants')" style="padding:0 0 16px 0;">
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              <span id="variants-count">View All Variants</span>
            </button>
            <div id="all-variants" class="collapsible__body">
              <div id="variants-list" class="variants-grid"></div>
            </div>
          </div>
        </div>

        <!-- SECTION 6: Analytics -->
        <div class="result-section">
          <div class="result-section__label">Analytics</div>

          <!-- Stats bar -->
          <div id="result-stats" style="padding:16px 20px;border-radius:12px;background:rgba(13,17,40,0.4);border:1px solid rgba(26,31,60,0.3);display:flex;flex-wrap:wrap;gap:24px;font-size:12px;color:rgba(232,234,246,0.3);margin-bottom:16px;"></div>

          <!-- Judge reasoning -->
          <div class="card" style="padding:16px 20px;margin-bottom:12px;">
            <button class="collapsible__trigger" onclick="toggleCollapsible('judge-reasoning')" style="padding:0;">
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              Judge's Reasoning
            </button>
            <div id="judge-reasoning" class="collapsible__body">
              <div id="result-reasoning" style="font-size:14px;line-height:1.6;color:rgba(232,234,246,0.55);padding:16px 0;"></div>
              <div id="result-improvements" style="font-size:13px;line-height:1.5;color:rgba(232,234,246,0.35);padding-bottom:8px;"></div>
            </div>
          </div>

          <!-- Cost Breakdown -->
          <div id="cost-breakdown" class="hidden card" style="padding:16px 20px;margin-bottom:12px;">
            <button class="collapsible__trigger" onclick="toggleCollapsible('cost-details')" style="padding:0;">
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              Cost Breakdown
            </button>
            <div id="cost-details" class="collapsible__body" style="overflow-x:auto;padding-top:16px;"></div>
          </div>

          <!-- Timing Breakdown -->
          <div id="timing-breakdown" class="hidden card" style="padding:16px 20px;">
            <button class="collapsible__trigger" onclick="toggleCollapsible('timing-details')" style="padding:0;">
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              Timing Breakdown
            </button>
            <div id="timing-details" class="collapsible__body" style="overflow-x:auto;padding-top:16px;"></div>
          </div>
        </div>

      </div>

      <!-- Results Footer -->
      <div style="display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:48px;padding-top:32px;border-top:1px solid rgba(26,31,60,0.4);">
        <img src="/static/logo.png" alt="AFTA" style="height:48px;width:auto;">
        <div style="font-size:13px;color:rgba(232,234,246,0.4);">Powered by <a href="https://afta.systems" target="_blank" style="color:var(--primary-500);text-decoration:none;">AFTA Systems</a></div>
      </div>
    </div>
  </div>
</section>

<div class="shell"><div class="section-divider"></div></div>

<footer>
  <div class="shell" style="display:flex;flex-direction:column;align-items:center;gap:16px;">
    <img src="/static/logo.png" alt="AFTA" style="height:48px;width:auto;">
    <div>Powered by <a href="https://afta.systems" target="_blank">AFTA Systems</a> &middot; AI Automation for E-commerce</div>
  </div>
</footer>
</div><!-- /view-dashboard -->

<script>
// ===== AUTH STATE =====
let currentUser = null;
let firebaseInitialized = false;
let userApproved = false;
let userIsAdmin = false;
let generationsRemaining = null;
let accessRequestStatus = null;

// ===== STATE =====
let selectedPersona = 'professional';
let sourceMode = 'auto';
let personas = [];
let models = [];
let selectedModel = 'gemini/gemini-3-pro-preview';
let defaultCompanyProfile = null;
let generatedCompanyProfile = null;
let lastProfileUrl = null;

// Carousel modal state
let carouselModalOpen = false;
let currentCarouselSlide = 0;
let carouselId = null;
const TOTAL_SLIDES = 5;

// ===== AUTH FUNCTIONS =====
async function initFirebase() {
  try {
    const res = await fetch('/api/auth/config');
    const config = await res.json();
    if (config.apiKey && config.projectId) {
      firebase.initializeApp(config);
      firebaseInitialized = true;
    }
  } catch (e) {
    console.warn('Firebase config not available');
  }
}

// ===== VIEW SYSTEM =====
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('view--active'));
  const view = document.getElementById('view-' + name);
  if (view) view.classList.add('view--active');
}

async function checkAuthAndRoute() {
  try {
    const res = await fetch('/api/auth/me');
    const data = await res.json();
    if (data.authenticated) {
      currentUser = data.user;
      userApproved = data.approved || false;
      userIsAdmin = data.is_admin || false;
      generationsRemaining = data.generations_remaining;
      accessRequestStatus = data.access_request_status;
      updateAuthUI(true);
      routeToView();
    } else {
      currentUser = null;
      userApproved = false;
      updateAuthUI(false);
      showView('landing');
    }
  } catch (e) {
    updateAuthUI(false);
    showView('landing');
  }
}

function routeToView() {
  if (!currentUser) {
    showView('landing');
    return;
  }
  if (userApproved || userIsAdmin) {
    showView('dashboard');
    updateCreditsBar();
    return;
  }
  if (accessRequestStatus === 'rejected') {
    showView('rejected');
    return;
  }
  if (accessRequestStatus === 'pending') {
    showView('pending');
    return;
  }
  showView('request-access');
}

function updateCreditsBar() {
  const bar = document.getElementById('credits-bar');
  const count = document.getElementById('credits-count');
  if (!bar || !count) return;

  if (userIsAdmin || generationsRemaining === null) {
    count.innerHTML = '<span class="credits-bar__unlimited">Unlimited</span> generations';
    bar.classList.remove('hidden');
  } else if (generationsRemaining !== undefined) {
    count.innerHTML = '<span class="credits-bar__count">' + generationsRemaining + '</span> generation' + (generationsRemaining !== 1 ? 's' : '') + ' remaining';
    bar.classList.remove('hidden');
  } else {
    bar.classList.add('hidden');
  }
}

function handleLandingCTA() {
  if (currentUser) {
    routeToView();
  } else {
    openAuthModal();
  }
}

async function handleRequestAccess() {
  const btn = document.getElementById('request-access-btn');
  btn.disabled = true;
  btn.innerHTML = '<svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="animation:spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke-width="2" stroke-dasharray="31.4 31.4"/></svg> Submitting...';

  try {
    const res = await fetch('/api/request-access', { method: 'POST' });
    const data = await res.json();
    if (data.success) {
      accessRequestStatus = data.status;
      if (data.status === 'approved') {
        userApproved = true;
        routeToView();
      } else {
        showView('pending');
      }
    }
  } catch (e) {
    btn.disabled = false;
    btn.innerHTML = 'Request Access';
    alert('Error: ' + e.message);
  }
}

function updateAuthUI(isAuthenticated) {
  const authBtn = document.getElementById('auth-btn');
  const userBadge = document.getElementById('user-badge');
  const userName = document.getElementById('user-name');

  if (isAuthenticated && currentUser) {
    authBtn.style.display = 'none';
    userBadge.style.display = 'flex';
    userName.textContent = currentUser.name || currentUser.email;
  } else {
    authBtn.style.display = 'block';
    userBadge.style.display = 'none';
  }
}

function openAuthModal() {
  document.getElementById('auth-modal').classList.add('auth-modal--open');
  document.getElementById('auth-error').classList.remove('auth-error--visible');
}

function closeAuthModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('auth-modal').classList.remove('auth-modal--open');
}

function showAuthError(message) {
  const errorEl = document.getElementById('auth-error');
  errorEl.textContent = message;
  errorEl.classList.add('auth-error--visible');
}

async function signInWithGoogle() {
  if (!firebaseInitialized) {
    showAuthError('Authentication not configured');
    return;
  }
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    const result = await firebase.auth().signInWithPopup(provider);
    await handleFirebaseUser(result.user);
  } catch (error) {
    if (error.code !== 'auth/popup-closed-by-user') {
      showAuthError(error.message);
    }
  }
}

async function signInWithMicrosoft() {
  if (!firebaseInitialized) {
    showAuthError('Authentication not configured');
    return;
  }
  const provider = new firebase.auth.OAuthProvider('microsoft.com');
  provider.setCustomParameters({ prompt: 'select_account' });
  try {
    const result = await firebase.auth().signInWithPopup(provider);
    await handleFirebaseUser(result.user);
  } catch (error) {
    if (error.code !== 'auth/popup-closed-by-user') {
      showAuthError(error.message);
    }
  }
}

async function handleFirebaseUser(user) {
  try {
    const idToken = await user.getIdToken();
    const res = await fetch('/api/auth/firebase', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ idToken })
    });
    const result = await res.json();
    if (result.error) {
      showAuthError(result.error);
      return;
    }
    currentUser = result.user;
    closeAuthModal();
    await checkAuthAndRoute();
  } catch (error) {
    showAuthError('Connection error. Please try again.');
  }
}

async function handleLogout() {
  try {
    await fetch('/api/auth/logout', { method: 'POST' });
    currentUser = null;
    userApproved = false;
    userIsAdmin = false;
    generationsRemaining = null;
    accessRequestStatus = null;
    updateAuthUI(false);
    showView('landing');
    // Sign out from Firebase as well
    if (firebaseInitialized) {
      await firebase.auth().signOut();
    }
  } catch (e) {
    console.error('Logout error:', e);
  }
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', async () => {
  // Initialize Firebase and check auth + route
  await initFirebase();
  await checkAuthAndRoute();

  // Fetch personas
  try {
    const res = await fetch('/api/personas');
    personas = await res.json();
    renderPersonas();
  } catch (e) {
    // Fallback personas if API not available
    personas = [
      { id: 'professional', name: 'Professional', description: 'Confident peer sharing discoveries with specific data', example_openers: ['I analyzed 47 failed automation projects. One pattern showed up in 43 of them.'] },
      { id: 'witty', name: 'Witty', description: 'Friend who happens to know stuff, uses observational humor', example_openers: ['Me at 2 AM: \'I\'ll just manually update these 200 SKUs real quick.\''] },
      { id: 'ai_meta', name: 'AI-Meta', description: 'Self-aware AI persona with clever irony and fourth-wall breaks', example_openers: ['I processed 50,000 LinkedIn posts to write this one.'] },
      { id: 'storyteller', name: 'Storyteller', description: 'Narrative-driven content with before/after transformations', example_openers: ['At 11 PM on a Tuesday, Sarah was manually updating 340 product prices.'] },
      { id: 'provocateur', name: 'Provocateur', description: 'Blunt contrarian who challenges industry orthodoxy with data', example_openers: ['Your Zapier setup isn\'t automation. It\'s a Rube Goldberg machine with a monthly fee.'] },
    ];
    renderPersonas();
  }

  // Fetch models
  try {
    const modelsRes = await fetch('/api/models');
    models = await modelsRes.json();
    renderModels();
  } catch (e) {
    // Fallback models if API not available
    models = [
      { id: 'gemini/gemini-3-pro-preview', name: 'Gemini 3 Pro', provider: 'google' },
      { id: 'claude-opus-4-5-20251101', name: 'Claude Opus 4.5', provider: 'anthropic' },
    ];
    renderModels();
  }

  // Fetch default company profile (used when target is afta.systems)
  try {
    const companyRes = await fetch('/api/default-company');
    defaultCompanyProfile = await companyRes.json();
  } catch (e) {
    // Fallback if API not available
    defaultCompanyProfile = {
      name: 'AFTA Systems',
      tagline: 'AI Automation for E-commerce',
      core_offering: 'Business process discovery + production-ready n8n automation',
      differentiator: 'We analyze your business first, then automate.',
      target_audience: ['DIY Automation Survivors', 'Struggling E-commerce Operators', 'Growing E-commerce Businesses'],
      key_services: ['Order processing', 'Inventory management', 'Customer support', 'Marketing automation'],
      proof_points: ['2-4 weeks to production'],
      pain_points_solved: ['Manual data entry', 'Inventory sync failures'],
      industry_keywords: ['e-commerce', 'automation', 'n8n'],
    };
  }

  // Show default profile card on load
  showProfileCard(defaultCompanyProfile, 'Default Profile');
});

// ===== PERSONA RENDERING =====
function renderPersonas() {
  const grid = document.getElementById('persona-grid');
  grid.innerHTML = personas.map(p => `
    <div class="persona-card ${p.id === selectedPersona ? 'persona-card--selected' : ''}"
         onclick="selectPersona('${p.id}')" data-persona="${p.id}">
      <div class="persona-card__name">${p.name}</div>
      <div class="persona-card__desc">${p.description}</div>
      <div class="persona-card__opener">"${p.example_openers[0]}"</div>
    </div>
  `).join('');
}

function selectPersona(id) {
  selectedPersona = id;
  document.querySelectorAll('.persona-card').forEach(c => {
    c.classList.toggle('persona-card--selected', c.dataset.persona === id);
  });
}

// ===== MODEL RENDERING =====
function renderModels() {
  const select = document.getElementById('generation-model');
  select.innerHTML = models.map(m =>
    `<option value="${m.id}" ${m.id === selectedModel ? 'selected' : ''}>${m.name}</option>`
  ).join('');
  select.addEventListener('change', (e) => { selectedModel = e.target.value; });
}

// ===== SOURCE TOGGLE =====
function setSourceMode(mode) {
  sourceMode = mode;
  document.getElementById('source-auto-btn').classList.toggle('source-toggle__btn--active', mode === 'auto');
  document.getElementById('source-paste-btn').classList.toggle('source-toggle__btn--active', mode === 'paste');
  document.getElementById('source-auto').classList.toggle('hidden', mode !== 'auto');
  document.getElementById('source-paste').classList.toggle('hidden', mode !== 'paste');
}

// ===== COMPANY PROFILE HELPERS =====
function isDefaultCompany(url) {
  if (!url) return true;
  try {
    const hostname = new URL(url).hostname.toLowerCase();
    return hostname === 'afta.systems' || hostname === 'www.afta.systems';
  } catch {
    return true;
  }
}

function showProfileCard(profile, badge, stats) {
  const card = document.getElementById('company-profile-card');
  document.getElementById('profile-badge').textContent = badge || 'Company Profile';
  document.getElementById('profile-name').textContent = profile.name;
  document.getElementById('profile-tagline').textContent = profile.tagline;
  document.getElementById('profile-offering').textContent = profile.core_offering;
  document.getElementById('profile-diff').textContent = profile.differentiator;
  document.getElementById('profile-audience').textContent = (profile.target_audience || []).join(', ');
  document.getElementById('profile-services').textContent = (profile.key_services || []).join(', ');
  document.getElementById('profile-proof').textContent = (profile.proof_points || []).join(', ');
  document.getElementById('profile-pains').textContent = (profile.pain_points_solved || []).join(', ');
  document.getElementById('profile-keywords').textContent = (profile.industry_keywords || []).join(', ');

  const statsEl = document.getElementById('profile-stats');
  if (stats) {
    const modelShort = (stats.model || '').split('/').pop().replace('gemini-', '').replace('-preview', '');
    document.getElementById('profile-model').textContent = modelShort;
    document.getElementById('profile-tokens').textContent = `${(stats.input_tokens || 0).toLocaleString()} in / ${(stats.output_tokens || 0).toLocaleString()} out`;
    document.getElementById('profile-cost').textContent = (stats.cost_usd || 0).toFixed(4);
    statsEl.classList.remove('hidden');
  } else {
    statsEl.classList.add('hidden');
  }

  card.classList.remove('hidden');
}

async function generateCompanyProfileFromUrl(url) {
  const res = await fetch('/api/generate-company-profile', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url }),
  });

  if (!res.ok) {
    // Handle 401 - show auth modal
    if (res.status === 401) {
      currentUser = null;
      updateAuthUI(false);
      openAuthModal();
      throw new Error('Authentication required');
    }
    const err = await res.json();
    throw new Error(err.detail || 'Failed to generate company profile');
  }

  const data = await res.json();

  // Show profile in UI and track URL
  lastProfileUrl = url;
  showProfileCard(data.profile, 'Generated Profile', {
    model: data.model,
    input_tokens: data.input_tokens,
    output_tokens: data.output_tokens,
    cost_usd: data.cost_usd,
  });

  return data.profile;
}

// ===== LOGO PREVIEW =====
let logoTimeout;
document.getElementById('target-url').addEventListener('blur', async function() {
  const url = this.value.trim();
  if (!url) return;

  // Update profile card when URL changes
  if (isDefaultCompany(url)) {
    showProfileCard(defaultCompanyProfile, 'Default Profile');
    generatedCompanyProfile = null;
  } else if (!generatedCompanyProfile || lastProfileUrl !== url) {
    // Hide old profile if URL changed
    document.getElementById('company-profile-card').classList.add('hidden');
  }

  const preview = document.getElementById('logo-preview');
  preview.classList.add('logo-preview--loading');
  try {
    const res = await fetch(`/api/scrape-logo?url=${encodeURIComponent(url)}`);
    const data = await res.json();
    if (data.logo_data_url) {
      preview.innerHTML = `<img src="${data.logo_data_url}" alt="Logo">`;
    }
  } catch (e) {}
  preview.classList.remove('logo-preview--loading');
});

// ===== GENERATE =====
async function handleGenerate() {
  // Check if user is authenticated
  if (!currentUser) {
    openAuthModal();
    return;
  }

  // Check approval
  if (!userApproved && !userIsAdmin) {
    routeToView();
    return;
  }

  // Check credits
  if (generationsRemaining !== null && generationsRemaining <= 0) {
    alert('No generations remaining. Contact admin for more credits.');
    return;
  }

  const targetUrl = document.getElementById('target-url').value.trim();
  if (!targetUrl) {
    document.getElementById('target-url').focus();
    document.getElementById('target-url').style.borderColor = 'rgba(236,72,153,0.5)';
    setTimeout(() => document.getElementById('target-url').style.borderColor = '', 2000);
    return;
  }

  const message = document.getElementById('message').value.trim();
  const sourceText = sourceMode === 'paste'
    ? document.getElementById('source-paste').value.trim() || 'auto'
    : 'auto';
  const numGenerators = parseInt(document.getElementById('num-generators').value);
  const generationModel = document.getElementById('generation-model').value;
  const autoSummarize = document.getElementById('auto-summarize').checked;

  const personaName = personas.find(p => p.id === selectedPersona)?.name || selectedPersona;
  const modelName = models.find(m => m.id === generationModel)?.name || generationModel;

  // Show loading
  document.getElementById('form-section').classList.add('hidden');
  document.getElementById('results-section').classList.add('hidden');
  document.getElementById('loading-section').classList.remove('hidden');
  document.getElementById('generate-btn').disabled = true;

  try {
    // Determine which company profile to use
    let companyProfile = null;  // null = use default on server (afta.systems)

    if (!isDefaultCompany(targetUrl)) {
      // Reuse cached profile if same URL, otherwise generate new one
      if (generatedCompanyProfile && lastProfileUrl === targetUrl) {
        companyProfile = generatedCompanyProfile;
      } else {
        document.getElementById('loading-persona').textContent = `Analyzing ${new URL(targetUrl).hostname}...`;
        companyProfile = await generateCompanyProfileFromUrl(targetUrl);
        generatedCompanyProfile = companyProfile;
      }
    }

    // Set loading text  detect if source looks like a URL
    const genMsg = `Using ${personaName} voice with ${modelName} (${numGenerators} samples)`;
    if (sourceText !== 'auto' && /^https?:\/\/\S+$/.test(sourceText.trim())) {
      const isYT = /youtube\.com\/(watch|shorts|live)|youtu\.be\//.test(sourceText);
      document.getElementById('loading-persona').textContent = isYT
        ? 'Analyzing YouTube video...'
        : 'Scraping URL content...';
      // Transition to generation message after a few seconds
      setTimeout(() => {
        const el = document.getElementById('loading-persona');
        if (el && !document.getElementById('loading-section').classList.contains('hidden')) {
          el.textContent = genMsg;
        }
      }, 5000);
    } else {
      document.getElementById('loading-persona').textContent = genMsg;
    }

    const res = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target_url: targetUrl,
        message: message,
        source_text: sourceText,
        persona: selectedPersona,
        num_generators: numGenerators,
        generation_model: generationModel,
        auto_summarize: autoSummarize,
        company_profile: companyProfile,
      }),
    });

    if (!res.ok) {
      // Handle 401 - show auth modal
      if (res.status === 401) {
        currentUser = null;
        updateAuthUI(false);
        openAuthModal();
        document.getElementById('loading-section').classList.add('hidden');
        document.getElementById('form-section').classList.remove('hidden');
        return;
      }
      // Handle 403 - not approved or out of credits
      if (res.status === 403) {
        document.getElementById('loading-section').classList.add('hidden');
        document.getElementById('form-section').classList.remove('hidden');
        const err = await res.json();
        alert(err.detail || 'Access denied');
        await checkAuthAndRoute();
        return;
      }
      const err = await res.json();
      throw new Error(err.detail || 'Generation failed');
    }

    const data = await res.json();

    // Decrement local credits counter
    if (generationsRemaining !== null) {
      generationsRemaining = Math.max(0, generationsRemaining - 1);
      updateCreditsBar();
    }

    showResults(data);
  } catch (e) {
    alert('Error: ' + e.message);
    document.getElementById('loading-section').classList.add('hidden');
    document.getElementById('form-section').classList.remove('hidden');
  } finally {
    document.getElementById('generate-btn').disabled = false;
  }
}

// ===== SHOW RESULTS =====
function showResults(data) {
  document.getElementById('loading-section').classList.add('hidden');
  document.getElementById('results-section').classList.remove('hidden');

  // Winner post
  document.getElementById('result-post').textContent = data.winning_post;

  // Score
  const score = data.score != null ? data.score.toFixed(1) : '';
  document.getElementById('result-score').textContent = score;

  // Source + persona tags
  const sourceLabels = { auto: 'Auto-fetched', paste: 'Custom', url_generic: 'Scraped URL', url_youtube: 'YouTube' };
  document.getElementById('result-source-tag').textContent = sourceLabels[data.source_mode] || (data.source_title ? 'Auto-fetched' : 'Custom');
  const pName = personas.find(p => p.id === data.persona_used)?.name || data.persona_used;
  document.getElementById('result-persona-name').textContent = pName;

  // Source article card
  document.getElementById('result-source-title').textContent = data.source_title || 'Custom Source';

  // Handle source summary with preview/full toggle
  const sourceSummary = data.source_summary || '';
  const previewLength = 250;
  const needsExpand = sourceSummary.length > previewLength;

  const previewEl = document.getElementById('result-source-summary-preview');
  const fullEl = document.getElementById('result-source-summary-full');
  const expandBtn = document.getElementById('source-expand-btn');

  if (needsExpand) {
    // Show truncated preview + expand button
    previewEl.textContent = sourceSummary.substring(0, previewLength) + '...';
    previewEl.style.display = '';
    fullEl.textContent = sourceSummary;
    fullEl.classList.remove('collapsible__body--open');
    expandBtn.style.display = '';
    expandBtn.classList.remove('collapsible__trigger--open');
    document.getElementById('source-expand-text').textContent = 'Show full article';
    sourceExpanded = false;
  } else {
    // Short text - show directly, hide expand button
    previewEl.textContent = sourceSummary;
    previewEl.style.display = '';
    fullEl.textContent = '';
    expandBtn.style.display = 'none';
  }

  // Score breakdown
  if (data.score_breakdown) {
    const sb = data.score_breakdown;
    const scores = [
      { label: 'Hook', value: sb.hook_strength, weight: '30%' },
      { label: 'Anti-Slop', value: sb.anti_slop, weight: '25%' },
      { label: 'Distinct', value: sb.distinctiveness, weight: '20%' },
      { label: 'Relevance', value: sb.relevance, weight: '15%' },
      { label: 'Persona', value: sb.persona_fit, weight: '10%' },
    ];
    document.getElementById('scores-grid').innerHTML = scores.map(s => `
      <div class="stat-card">
        <div class="stat-card__value">${s.value.toFixed(1)}</div>
        <div class="stat-card__label">${s.label}</div>
        <div class="stat-card__weight">${s.weight}</div>
      </div>
    `).join('');
  }

  // Judge reasoning
  document.getElementById('result-reasoning').textContent = data.judge_reasoning || '';
  const improvements = document.getElementById('result-improvements');
  if (data.improvement_notes) {
    improvements.textContent = 'Improvements: ' + data.improvement_notes;
    improvements.style.display = '';
  } else {
    improvements.style.display = 'none';
  }

  // Carousel - store ID and show preview
  carouselId = data.carousel_id;
  const carouselPreviewUrl = `/api/carousel/preview/${data.carousel_id}`;
  document.getElementById('carousel-iframe').src = carouselPreviewUrl;
  document.getElementById('carousel-download').href = data.carousel_pdf_url;

  // Variants - full content with copy buttons
  const variants = data.all_variants || [];
  document.getElementById('variants-count').textContent = `View All ${variants.length} Variants`;
  document.getElementById('variants-list').innerHTML = variants.map((v, i) => `
    <div class="variant-card--full">
      <div class="variant-card__header">
        <span class="variant-card__number">#${i + 1}</span>
        <button class="variant-card__copy" data-copy-variant="${i}" onclick="copyVariant(${i})">
          <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" stroke-width="1.5"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" stroke-width="1.5"/></svg>
          Copy
        </button>
      </div>
      <div class="variant-card__content" data-variant-content="${i}">${escapeHtml(v.content)}</div>
      <div class="variant-card__footer">
        <span class="variant-card__tag">${escapeHtml(v.hook_type)}</span>
        <span class="variant-card__tag">${escapeHtml(v.structure_used)}</span>
      </div>
    </div>
  `).join('');

  // Stats bar
  const stats = data.stats || {};
  const costs = data.costs || {};
  const modelDisplayName = stats.generation_model
    ? (models.find(m => m.id === stats.generation_model)?.name || stats.generation_model.split('/').pop())
    : '';

  // Format cost with dollar sign
  const formatCost = (cost) => cost != null ? `$${cost.toFixed(4)}` : '';

  // Show which company profile was used in results
  const activeProfile = generatedCompanyProfile || defaultCompanyProfile;
  const companyName = activeProfile?.name || 'AFTA Systems';
  const companyBadge = generatedCompanyProfile ? 'Generated Profile' : 'Default Profile';
  document.getElementById('result-company-badge').textContent = companyBadge;
  document.getElementById('result-company-name').textContent = companyName;
  document.getElementById('result-company-tagline').textContent = activeProfile?.tagline || '';
  document.getElementById('result-cp-offering').textContent = activeProfile?.core_offering || '';
  document.getElementById('result-cp-diff').textContent = activeProfile?.differentiator || '';
  document.getElementById('result-cp-audience').textContent = (activeProfile?.target_audience || []).join(', ');
  document.getElementById('result-cp-services').textContent = (activeProfile?.key_services || []).join(', ');
  document.getElementById('result-cp-pains').textContent = (activeProfile?.pain_points_solved || []).join(', ');
  document.getElementById('result-cp-keywords').textContent = (activeProfile?.industry_keywords || []).join(', ');

  document.getElementById('result-stats').innerHTML = [
    `<strong style="color:var(--electric-purple);">Company: ${escapeHtml(companyName)}</strong>`,
    `Model: ${modelDisplayName}`,
    `Generators: ${stats.total_generators || ''}`,
    `Total variants: ${stats.total_variants || ''}`,
    `Slop filtered: ${stats.slop_violations || 0}`,
    `<strong style="color:var(--accent-light);">Duration: ${stats.duration_seconds ? stats.duration_seconds.toFixed(1) + 's' : ''}</strong>`,
    costs.total_cost_usd != null ? `<strong style="color:var(--primary-300);">Total Cost: ${formatCost(costs.total_cost_usd)}</strong>` : '',
  ].filter(Boolean).map(s => `<span>${s}</span>`).join('');

  // Cost breakdown
  const costBreakdown = document.getElementById('cost-breakdown');
  if (costs.steps && Object.keys(costs.steps).length > 0) {
    costBreakdown.classList.remove('hidden');
    const stepNames = {
      'news_filter': 'News Filter',
      'source_analysis': 'Source Analysis',
      'auto_summarize': 'Auto-Summarize',
      'generation': 'Generation',
      'judge': 'Judge',
      'carousel': 'Carousel',
    };
    const stepRows = Object.entries(costs.steps).map(([name, step]) => `
      <tr>
        <td>${stepNames[name] || name}</td>
        <td>${step.model ? step.model.split('/').pop().split('-').slice(0,2).join('-') : ''}</td>
        <td>${step.input_tokens?.toLocaleString() || 0}</td>
        <td>${step.output_tokens?.toLocaleString() || 0}</td>
        <td>${step.call_count || 1}</td>
        <td>${formatCost(step.cost_usd)}</td>
      </tr>
    `).join('');

    document.getElementById('cost-details').innerHTML = `
      <table class="cost-table">
        <thead>
          <tr>
            <th>Step</th>
            <th>Model</th>
            <th>Input</th>
            <th>Output</th>
            <th>Calls</th>
            <th>Cost</th>
          </tr>
        </thead>
        <tbody>${stepRows}</tbody>
        <tfoot>
          <tr>
            <td colspan="2"><strong>Total</strong></td>
            <td><strong>${costs.total_input_tokens?.toLocaleString() || 0}</strong></td>
            <td><strong>${costs.total_output_tokens?.toLocaleString() || 0}</strong></td>
            <td></td>
            <td><strong>${formatCost(costs.total_cost_usd)}</strong></td>
          </tr>
        </tfoot>
      </table>
    `;
  } else {
    costBreakdown.classList.add('hidden');
  }

  // Timing breakdown
  const timingBreakdown = document.getElementById('timing-breakdown');
  const timings = (data.stats || {}).timings;
  if (timings && Object.keys(timings).length > 0) {
    timingBreakdown.classList.remove('hidden');

    const stepLabels = {
      'scrape_metadata': 'Scrape Website',
      'resolve_source': 'Resolve Source (total)',
      'source_news_fetch': 'RSS Fetch',
      'source_embedding_filter': 'Embedding Filter',
      'source_ai_filter': 'AI Filter',
      'auto_summarize': 'Auto-Summarize',
      'load_configs': 'Load Configs',
      'generation': 'Generation (parallel)',
      'anti_slop': 'Anti-Slop Validation',
      'judge': 'Judge Evaluation',
      'carousel': 'Carousel Generation',
    };

    const stepOrder = [
      'scrape_metadata', 'resolve_source',
      'source_news_fetch', 'source_embedding_filter', 'source_ai_filter',
      'auto_summarize', 'load_configs', 'generation',
      'anti_slop', 'judge', 'carousel'
    ];

    const presentSteps = stepOrder.filter(key => timings[key] != null);
    const maxDuration = Math.max(...presentSteps.map(k => timings[k]));
    const totalDuration = data.stats.duration_seconds || 0;

    const timingRows = presentSteps.map(key => {
      const duration = timings[key];
      const pct = maxDuration > 0 ? (duration / maxDuration) * 100 : 0;
      const isSubstep = key.startsWith('source_');
      const label = stepLabels[key] || key;
      const isSlow = duration > 10;
      return `
        <tr${isSubstep ? ' style="opacity:0.7;"' : ''}>
          <td>${isSubstep ? '<span style="color:rgba(232,234,246,0.3);margin-right:4px;">\u2514</span>' : ''}${label}</td>
          <td style="font-family:var(--font-display);font-weight:600;${isSlow ? 'color:var(--accent-light);' : ''}">${duration.toFixed(1)}s</td>
          <td style="width:40%;"><div class="timing-bar${isSlow ? ' timing-bar--slow' : ''}" style="width:${pct}%;"></div></td>
        </tr>`;
    }).join('');

    document.getElementById('timing-details').innerHTML = `
      <table class="timing-table">
        <thead>
          <tr>
            <th>Step</th>
            <th>Duration</th>
            <th>Relative</th>
          </tr>
        </thead>
        <tbody>${timingRows}</tbody>
        <tfoot>
          <tr>
            <td><strong>Total (wall clock)</strong></td>
            <td><strong>${totalDuration.toFixed(1)}s</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    `;
  } else {
    timingBreakdown.classList.add('hidden');
  }

  // Scroll to top of results
  document.getElementById('results-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ===== UTILS =====
function resetToForm() {
  document.getElementById('results-section').classList.add('hidden');
  document.getElementById('form-section').classList.remove('hidden');
  document.getElementById('generate').scrollIntoView({ behavior: 'smooth' });
}

function copyWinner() {
  const text = document.getElementById('result-post').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.classList.add('copy-btn--copied');
    btn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
    setTimeout(() => {
      btn.classList.remove('copy-btn--copied');
      btn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" stroke-width="1.5"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" stroke-width="1.5"/></svg> Copy';
    }, 2000);
  });
}

function toggleCollapsible(id) {
  const body = document.getElementById(id);
  const trigger = body.previousElementSibling;
  body.classList.toggle('collapsible__body--open');
  trigger.classList.toggle('collapsible__trigger--open');
}

function escapeHtml(text) {
  const d = document.createElement('div');
  d.textContent = text;
  return d.innerHTML;
}

// ===== CAROUSEL MODAL =====
function openCarouselModal() {
  if (!carouselId) return;

  carouselModalOpen = true;
  currentCarouselSlide = 0;

  const modal = document.getElementById('carousel-modal');
  modal.classList.add('carousel-modal--open');
  document.body.style.overflow = 'hidden';

  // Set download link
  document.getElementById('modal-download-btn').href = `/api/carousel/download/${carouselId}`;

  // Render dots
  renderModalDots();

  // Load first slide
  loadModalSlide(0);
}

function closeCarouselModal() {
  carouselModalOpen = false;
  const modal = document.getElementById('carousel-modal');
  modal.classList.remove('carousel-modal--open');
  document.body.style.overflow = '';
}

function modalNavigate(direction) {
  const newSlide = currentCarouselSlide + direction;
  if (newSlide < 0 || newSlide >= TOTAL_SLIDES) return;
  currentCarouselSlide = newSlide;
  loadModalSlide(newSlide);
  updateModalDots();
  updateNavButtons();
}

function loadModalSlide(slideIndex) {
  const iframe = document.getElementById('modal-carousel-iframe');
  iframe.src = `/api/carousel/preview/${carouselId}?slide=${slideIndex}`;
}

function renderModalDots() {
  const dotsContainer = document.getElementById('modal-dots');
  dotsContainer.innerHTML = Array.from({ length: TOTAL_SLIDES }, (_, i) => `
    <button class="carousel-modal__dot ${i === 0 ? 'carousel-modal__dot--active' : ''}"
            onclick="goToSlide(${i})" title="Slide ${i + 1}"></button>
  `).join('');
  updateNavButtons();
}

function updateModalDots() {
  const dots = document.querySelectorAll('.carousel-modal__dot');
  dots.forEach((dot, i) => {
    dot.classList.toggle('carousel-modal__dot--active', i === currentCarouselSlide);
  });
}

function updateNavButtons() {
  document.getElementById('modal-prev-btn').disabled = currentCarouselSlide === 0;
  document.getElementById('modal-next-btn').disabled = currentCarouselSlide === TOTAL_SLIDES - 1;
}

function goToSlide(index) {
  currentCarouselSlide = index;
  loadModalSlide(index);
  updateModalDots();
  updateNavButtons();
}

function handleModalBackdropClick(event) {
  if (event.target.classList.contains('carousel-modal')) {
    closeCarouselModal();
  }
}

// Keyboard navigation for modal
document.addEventListener('keydown', (e) => {
  if (!carouselModalOpen) return;

  switch (e.key) {
    case 'Escape':
      closeCarouselModal();
      break;
    case 'ArrowLeft':
      modalNavigate(-1);
      break;
    case 'ArrowRight':
      modalNavigate(1);
      break;
  }
});

// ===== SOURCE EXPAND =====
let sourceExpanded = false;

function toggleSourceExpand() {
  sourceExpanded = !sourceExpanded;
  const preview = document.getElementById('result-source-summary-preview');
  const full = document.getElementById('result-source-summary-full');
  const btn = document.getElementById('source-expand-btn');
  const text = document.getElementById('source-expand-text');

  if (sourceExpanded) {
    preview.style.display = 'none';
    full.classList.add('collapsible__body--open');
    btn.classList.add('collapsible__trigger--open');
    text.textContent = 'Show less';
  } else {
    preview.style.display = '';
    full.classList.remove('collapsible__body--open');
    btn.classList.remove('collapsible__trigger--open');
    text.textContent = 'Show full article';
  }
}

// ===== VARIANT COPY =====
function copyVariant(index) {
  const content = document.querySelector(`[data-variant-content="${index}"]`);
  if (!content) return;

  navigator.clipboard.writeText(content.textContent).then(() => {
    const btn = document.querySelector(`[data-copy-variant="${index}"]`);
    btn.classList.add('variant-card__copy--copied');
    btn.innerHTML = '<svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied';
    setTimeout(() => {
      btn.classList.remove('variant-card__copy--copied');
      btn.innerHTML = '<svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" stroke-width="1.5"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" stroke-width="1.5"/></svg> Copy';
    }, 2000);
  });
}
</script>

<!-- Carousel Modal -->
<div id="carousel-modal" class="carousel-modal" onclick="handleModalBackdropClick(event)">
  <div class="carousel-modal__header">
    <button class="carousel-modal__close" onclick="closeCarouselModal()" title="Close (Esc)">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    <a id="modal-download-btn" class="btn-primary" href="#" download style="text-decoration:none;">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
      Download HTML
    </a>
  </div>

  <div class="carousel-modal__content" onclick="event.stopPropagation()">
    <button id="modal-prev-btn" class="carousel-modal__nav" onclick="modalNavigate(-1)" title="Previous (Left Arrow)">
      <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    </button>

    <div class="carousel-modal__slide-wrap">
      <iframe id="modal-carousel-iframe" title="Carousel slide"></iframe>
    </div>

    <button id="modal-next-btn" class="carousel-modal__nav" onclick="modalNavigate(1)" title="Next (Right Arrow)">
      <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
    </button>
  </div>

  <div id="modal-dots" class="carousel-modal__dots">
    <!-- Dots populated by JS -->
  </div>
</div>

<!-- ===== AUTH MODAL ===== -->
<div id="auth-modal" class="auth-modal" onclick="closeAuthModal(event)">
  <div class="auth-modal__card" onclick="event.stopPropagation()">
    <h2 class="auth-modal__title">Sign In to Generate</h2>
    <p class="auth-modal__subtitle">Sign in to create LinkedIn posts</p>

    <button onclick="signInWithGoogle()" class="auth-btn auth-btn--google">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Continue with Google
    </button>

    <button onclick="signInWithMicrosoft()" class="auth-btn auth-btn--microsoft">
      <svg width="20" height="20" viewBox="0 0 23 23">
        <path fill="#f35325" d="M1 1h10v10H1z"/>
        <path fill="#81bc06" d="M12 1h10v10H12z"/>
        <path fill="#05a6f0" d="M1 12h10v10H1z"/>
        <path fill="#ffba08" d="M12 12h10v10H12z"/>
      </svg>
      Continue with Microsoft
    </button>

    <div id="auth-error" class="auth-error"></div>
  </div>
</div>

</body>
</html>
